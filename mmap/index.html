<!DOCTYPE html>
<html>
<head>
  <title>The Real Marauder's Map</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <script src="http://maps.google.com/maps/api/js?sensor=true"></script>
  <script type="text/javascript">
    // username: JoshRamsey
    var me = new google.maps.LatLng(0, 0);
    var mapOptions = {
        center: me,
        zoom: 11
      };
    var map;
    var infowindow = new google.maps.InfoWindow(); 

    function init(){
      map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
      console.log(map);
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(sendLocationData);
      }
    }

    function sendLocationData(pos){
      lat = pos.coords.latitude;
      lng = pos.coords.longitude;
      me = new google.maps.LatLng(lat, lng);                
      map.panTo(me);
      request = new XMLHttpRequest();
      alert("lat: " + lat + " lng: " + lng);
      requestURL = "https://secret-about-box.herokuapp.com/sendLocation"
      params = "login=JoshRamsey&lat=" + lat +"&lng=" + lng;
      alert(params);
      request.open("POST", requestURL, true);
      request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      request.onreadystatechange = parseMapData;
      request.send(params);
    }

    function parseMapData(){
      if(request.readyState == 4 && request.status == 200){
        responseObject = JSON.parse(request.responseText);
        responseObject.forEach(function(locationObject){
          console.log(locationObject["login"]);
          var personLocation = new google.maps.LatLng(locationObject["lat"],
                                                  locationObject["lng"]);
          var marker = new google.maps.Marker({
            position: personLocation,
            title: locationObject["login"],
            map: map 
          });
          google.maps.event.addListener(marker, 'click', function() {
            // infowindow.close();
            infowindow.setContent(this.title);
            infowindow.open(map, this);
          });
        });
      }
    } 
  </script>
</head>
<body onload="init()">
  <div id="map-canvas" style="width:100%; height:100%"></div>
</body>
</html>